<!DOCTYPE html>
<html class="dark overflow-hidden h-full h-[100dvh]" lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
    <title>远程播放器</title>
    <link href="fonts/splinesans.css" rel="stylesheet"/>
    <link href="fonts/notosans.css" rel="stylesheet"/>
    <link href="fonts/symbols.css" rel="stylesheet"/>
    <!-- Use Tailwind via CDN for simplicity as in code.html -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class", 
            theme: {
                extend: {
                    colors: {
                        primary: "#359EFF", 
                        "background-light": "#f5f7f8", 
                        "background-dark": "#0f1923", 
                        "surface-dark": "#1b2327", 
                        "border-dark": "#283339", 
                        "text-secondary": "#9cb0ba"
                    }, 
                    fontFamily: {
                        display: "Spline Sans", 
                        body: ["Noto Sans", "sans-serif"]
                    }, 
                    borderRadius: {
                        DEFAULT: "0.5rem", 
                        lg: "1rem", 
                        xl: "1.5rem", 
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111618; 
        }
        ::-webkit-scrollbar-thumb {
            background: #283339; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3b4c54; 
        }
        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: #283339;
            border-radius: 2px;
            outline: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 0 0 2px #1b2327;
        }
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #359EFF;
        }
        .file-row {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), background-color 0.4s ease, border-color 0.4s ease;
            border: 1px solid transparent;
            will-change: transform;
        }
        .file-row:hover {
            background-color: rgba(53, 158, 255, 0.08);
            border-color: rgba(53, 158, 255, 0.2);
            transform: translateX(2px);
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        .file-row.active {
            background-color: rgba(255, 255, 255, 0.08);
            color: white;
        }
        .file-row.active .material-symbols-outlined:first-child {
            color: #359EFF;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        
        /* New premium effects */
        .btn-premium {
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .btn-premium:active {
            transform: scale(0.92);
        }
        .btn-premium:hover {
            transform: translateY(-1px);
        }

        .file-row.active {
            background: linear-gradient(90deg, rgba(53, 158, 255, 0.1) 0%, rgba(53, 158, 255, 0.05) 100%);
            color: white;
            box-shadow: inset 0 0 20px rgba(53, 158, 255, 0.05);
        }
    </style>
    <script src="Recorder.js"></script> 
</head>
<body class="bg-[#0b1219] text-white font-body min-h-[100dvh] max-h-[100dvh] overflow-hidden flex justify-center items-center p-0 md:p-10 antialiased selection:bg-primary selection:text-white touch-manipulation">

    <div class="w-full md:w-[60%] h-full h-[100dvh] md:h-[90vh] flex flex-col bg-background-dark shadow-2xl md:rounded-[10px] relative overflow-hidden">


    <!-- Header (Fixed Top) -->
    <header class="flex-none flex flex-col md:flex-row md:items-center justify-between gap-2 px-4 sm:px-6 py-2 md:py-4 bg-[#1e293b]/30 backdrop-blur-md z-20 border-b border-white/5">
        <!-- Title & Status Row (Mobile: Full Width, Desktop: Left Side) -->
        <div class="flex items-center justify-between w-full md:w-auto gap-3">
            <div class="flex items-center gap-2 overflow-hidden">
                <div class="w-8 h-8 sm:w-11 sm:h-11 rounded-lg sm:rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg shadow-blue-900/40 flex-none relative overflow-hidden group">
                    <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <span class="material-symbols-outlined text-white text-lg sm:text-2xl relative">music_note</span>
                </div>
                <h1 class="text-lg sm:text-2xl font-display font-bold tracking-tight text-white whitespace-nowrap truncate">音频播放器&对讲</h1>
            </div>
            <span id="connection-status" class="text-[9px] sm:text-[10px] px-2 py-0.5 rounded-full bg-white/5 text-text-secondary font-bold uppercase tracking-widest border border-white/5 flex-none">连接中...</span>
        </div>
        
        <!-- Actions Row (Mobile: Below Title, Desktop: Right Side) -->
        <div class="flex items-center gap-2 sm:gap-3 w-full md:w-auto">
            <div class="flex items-center gap-2 flex-1 md:flex-none">
                <!-- Upload Button -->
                <button onclick="document.getElementById('file-upload').click()" class="btn-premium flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-surface-dark border border-white/5 hover:bg-white/5 text-xs font-semibold text-text-secondary hover:text-white">
                    <span class="material-symbols-outlined text-lg">library_music</span>
                    <span class="whitespace-nowrap">上传</span>
                </button>
                <input type="file" id="file-upload" class="hidden" accept=".mp3,.wav,.ogg,.flac,.pcm" onchange="handleFileUpload(this)">

                <!-- Intercom Button -->
                <button id="btn-intercom" onmousedown="startIntercom()" onmouseup="stopIntercom()" onmouseleave="stopIntercom()" class="btn-premium flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/20 text-xs font-bold active:bg-indigo-700 select-none">
                    <span class="material-symbols-outlined text-lg">mic</span>
                    <span class="whitespace-nowrap uppercase tracking-wider">对讲</span>
                </button>
            </div>

            <button class="btn-premium w-10 h-10 rounded-xl hover:bg-surface-dark border border-transparent hover:border-white/5 flex items-center justify-center text-text-secondary hover:text-white flex-none">
                <span class="material-symbols-outlined text-xl">settings</span>
            </button>
        </div>
    </header>

    <!-- Main Content (Scrollable List) -->
    <main class="flex-1 flex flex-col w-full min-h-0 p-0 sm:p-4 md:p-6 relative">
        
        <!-- List Container -->
        <div class="flex-1 flex flex-col bg-surface-dark/40 rounded-none sm:rounded-[6px] overflow-hidden relative">
            <!-- Toolbar -->
            <div class="flex-none p-4 flex items-center justify-between gap-4 bg-white/[0.02]">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-text-secondary uppercase tracking-wider px-2">媒体库</span>
                    <span id="file-count" class="bg-primary/20 text-primary text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    <span id="upload-status" class="text-xs text-primary hidden ml-2">正在上传...</span>
                </div>
                <!-- Sort Controls -->
                <div class="flex items-center gap-2 bg-black/20 rounded-lg p-1">
                    <button id="sort-date" onclick="setSort('date')" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all text-text-secondary hover:text-white hover:bg-white/5">日期</button>
                    <div class="w-px h-4 bg-border-dark"></div>
                    <button id="sort-name" onclick="setSort('name')" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all text-text-secondary hover:text-white hover:bg-white/5">名称</button>
                </div>
            </div>

            <!-- List Header -->
            <div class="flex-none grid grid-cols-12 gap-4 px-4 sm:px-6 py-3 text-xs font-medium text-text-secondary uppercase tracking-wider bg-white/[0.01] z-10">
                <div class="col-span-8 sm:col-span-5">文件名</div>
                <div class="hidden sm:block col-span-3 text-right">日期</div>
                <div class="col-span-2 sm:col-span-2 text-right">时长</div>
                <div class="hidden sm:block col-span-1 text-right">大小</div>
                <div class="col-span-2 sm:col-span-1 text-right">操作</div>
            </div>

            <!-- Scrollable List -->
            <div class="flex-1 overflow-y-auto p-1 space-y-0 scroll-smooth" id="file-list">
                <!-- Dynamic Items -->
            </div>
        </div>
    </main>

    <!-- Bottom Player Bar (Fixed Footer) -->
    <footer class="flex-none bg-[#1e293b]/60 backdrop-blur-xl p-3 sm:p-5 md:px-8 shadow-[0_-10px_40px_rgba(0,0,0,0.6)] z-30 border-t border-white/5">
        <div class="flex flex-col md:flex-row items-center justify-between gap-5">
            
            <!-- Left: Current Track Info (Row 1 on Mobile, Left-side on PC) -->
            <div class="flex items-center gap-3 w-full md:w-1/3 min-w-0">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary/10 to-blue-600/10 border border-primary/20 flex-none flex items-center justify-center shadow-inner shadow-blue-500/5 text-primary relative overflow-hidden group">
                    <div id="playing-glow" class="absolute inset-0 bg-primary/20 blur-xl opacity-0 transition-opacity duration-1000"></div>
                    <span id="playing-icon" class="material-symbols-outlined text-xl relative">music_note</span>
                </div>
                <div class="flex flex-col overflow-hidden">
                     <h2 id="current-track-name" class="text-xs sm:text-base font-display font-bold truncate text-white tracking-tight">未选择文件</h2>
                     <div class="flex items-center gap-1.5 mt-0.5">
                         <span class="w-1 h-1 rounded-full bg-primary/60 animate-pulse"></span>
                         <span class="text-[9px] text-text-secondary uppercase tracking-widest font-bold">正在播放</span>
                     </div>
                </div>
            </div>

            <!-- Controls (Center on PC, Row 2 on Mobile) -->
            <div class="flex items-center justify-center gap-4 sm:gap-7 w-full md:w-1/3">
                <button id="btn-loop" onclick="toggleLoopMode()" class="btn-premium material-symbols-outlined text-xl transition-colors text-text-secondary hover:text-white active:scale-90" title="循环模式">
                    <span id="icon-loop">repeat</span>
                </button>
                <button onclick="playPrev()" class="btn-premium material-symbols-outlined text-2xl transition-colors text-text-secondary hover:text-white active:scale-90">skip_previous</button>
                <button onclick="togglePlay()" class="btn-premium w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-primary hover:bg-blue-400 flex items-center justify-center text-white shadow-xl shadow-primary/25 transition-all active:scale-90 ring-4 ring-white/5">
                    <span id="icon-play" class="material-symbols-outlined text-3xl sm:text-4xl">play_arrow</span>
                </button>
                <button onclick="playNext()" class="btn-premium material-symbols-outlined text-2xl transition-colors text-text-secondary hover:text-white active:scale-90">skip_next</button>
            </div>

            <!-- Volume (Right on PC, Row 3 on Mobile) -->
            <div class="flex items-center gap-3 w-full md:w-1/3 justify-center md:justify-end">
                <span class="material-symbols-outlined text-xl text-text-secondary">volume_up</span>
                <div class="relative flex-1 md:flex-none md:w-32 lg:w-40 h-1.5 bg-white/5 rounded-full overflow-hidden group">
                    <input type="range" class="range-slider absolute inset-0 opacity-100 cursor-pointer z-10" min="0" max="100" value="100" id="volume-slider" oninput="updateVolume(this.value)">
                </div>
                <span id="volume-label" class="text-xs font-mono font-bold text-text-secondary w-10 text-right">100%</span>
            </div>
        </div>
    </footer>

    </div>

    <!-- Scripts -->
    <script>
        // --- State ---
        let ws;
        let fileList = [];
        let currentFile = null;
        let isPlaying = false;
        let isPaused = false;
        let loopMode = 'list'; // 'list' or 'single'
        let currentSort = 'date'; // 'date' or 'name'

        const nameEl = document.getElementById('current-track-name');
        const statusEl = document.getElementById('connection-status');
        const playingIcon = document.getElementById('playing-icon');
        
        // Intercom
        let recorder = null;
        let isRecording = false;

        // --- WebSocket ---
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:8888`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Connected');
                statusEl.textContent = "已连接";
                statusEl.classList.remove('text-text-secondary', 'border-border-dark');
                statusEl.classList.add('text-green-500', 'border-green-500/30');
                ws.send(JSON.stringify({type: 'list'}));
            };

            ws.onclose = () => {
                statusEl.textContent = "未连接";
                statusEl.classList.remove('text-green-500', 'border-green-500/30');
                statusEl.classList.add('text-red-500', 'border-red-500/30');
                setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'list') {
                        fileList = data.files;
                        renderList();
                        const upStatus = document.getElementById('upload-status');
                        if(upStatus) upStatus.classList.add('hidden');
                    } else if (data.type === 'ended') {
                        console.log('Playback ended event received');
                        handleFileEnded();
                    }
                } catch (e) {
                    console.error("JSON Error", e);
                }
            };
        }

        // --- Logic ---

        function renderList() {
            const listEl = document.getElementById('file-list');
            const countEl = document.getElementById('file-count');
            listEl.innerHTML = '';
            
            // Sort
            fileList.sort((a, b) => {
                if (currentSort === 'date') {
                    return b.mtime - a.mtime; // Newest first
                } else {
                    return a.name.localeCompare(b.name);
                }
            });

            countEl.textContent = fileList.length;
            
            // Update Sort Buttons Style
            document.getElementById('sort-date').classList.toggle('bg-white/10', currentSort === 'date');
            document.getElementById('sort-date').classList.toggle('text-white', currentSort === 'date');
            document.getElementById('sort-name').classList.toggle('bg-white/10', currentSort === 'name');
            document.getElementById('sort-name').classList.toggle('text-white', currentSort === 'name');

            fileList.forEach(file => {
                const div = document.createElement('div');
                div.className = `grid grid-cols-12 gap-4 px-4 py-1 rounded-[6px] cursor-pointer transition-all file-row group ${currentFile === file.name ? 'active' : ''}`;
                div.ondblclick = () => playFile(file.name);

                // Date Format
                const date = new Date(file.mtime * 1000).toLocaleDateString();
                
                // Duration Format
                const durMin = Math.floor(file.duration / 60);
                const durSec = Math.floor(file.duration % 60).toString().padStart(2, '0');
                const durStr = file.duration ? `${durMin}:${durSec}` : '--:--';

                // Size Format
                const sizeMB = (file.size / (1024 * 1024)).toFixed(1);

                div.innerHTML = `
                    <div class="col-span-8 sm:col-span-5 flex items-center gap-3 overflow-hidden">
                        <span class="material-symbols-outlined text-text-secondary group-hover:text-primary transition-colors text-lg flex-none">music_note</span>
                        <span class="truncate text-sm font-medium text-gray-200 group-hover:text-white">${file.name}</span>
                    </div>
                    <div class="hidden sm:flex col-span-3 text-right text-xs text-text-secondary items-center justify-end">${date}</div>
                    <div class="col-span-2 text-right text-xs font-mono text-text-secondary flex items-center justify-end">${durStr}</div>
                    <div class="hidden sm:flex col-span-1 text-right text-xs font-mono text-text-secondary items-center justify-end">${sizeMB}M</div>
                    <div class="col-span-2 sm:col-span-1 text-right flex items-center justify-end">
                        <button onclick="deleteFile(event, '${file.name}')" class="p-1.5 rounded hover:bg-red-500/20 text-text-secondary hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        function setSort(mode) {
            currentSort = mode;
            renderList();
        }

        function deleteFile(event, filename) {
            event.stopPropagation();
            if (confirm(`确定要永久删除音频文件 ${filename} 吗？`)) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'delete', file: filename }));
                    if (currentFile === filename) {
                        currentFile = null;
                        isPlaying = false;
                        isPaused = false;
                        updatePlayButton();
                        nameEl.textContent = "未选择文件";
                        playingIcon.classList.remove('animate-spin-slow');
                        const glow = document.getElementById('playing-glow');
                        if(glow) glow.classList.remove('opacity-100');
                    }
                }
            }
        }

        function playFile(filename) {
            currentFile = filename;
            isPlaying = true;
            isPaused = false;
            updatePlayButton();
            renderList(); // Update active highlight
            nameEl.textContent = filename;
            playingIcon.classList.add('animate-spin-slow');
            
            const glow = document.getElementById('playing-glow');
            if(glow) glow.classList.add('opacity-100');
            
            ws.send(JSON.stringify({ type: 'play', file: filename }));
        }

        function togglePlay() {
            if (!currentFile && fileList.length > 0) {
                playFile(fileList[0].name);
                return;
            }
            if (!currentFile) return;

            if (isPlaying && !isPaused) {
                // Pause
                ws.send(JSON.stringify({ type: 'pause' }));
                isPaused = true;
                playingIcon.classList.remove('animate-spin-slow');
                const glow = document.getElementById('playing-glow');
                if(glow) glow.classList.remove('opacity-100');
            } else if (isPlaying && isPaused) {
                // Resume
                ws.send(JSON.stringify({ type: 'resume' }));
                isPaused = false;
                playingIcon.classList.add('animate-spin-slow');
                const glow = document.getElementById('playing-glow');
                if(glow) glow.classList.add('opacity-100');
            } else {
                // Was stopped, replay current?
                playFile(currentFile);
            }
            updatePlayButton();
        }

        function updatePlayButton() {
            const icon = document.getElementById('icon-play');
            if (isPlaying && !isPaused) {
                icon.textContent = 'pause';
            } else {
                icon.textContent = 'play_arrow';
            }
        }

        function playNext() {
            if (!currentFile || fileList.length === 0) return;
            const idx = fileList.findIndex(f => f.name === currentFile);
            let nextIdx = idx + 1;
            if (nextIdx >= fileList.length) nextIdx = 0; // Wrap
            playFile(fileList[nextIdx].name);
        }

        function playPrev() {
            if (!currentFile || fileList.length === 0) return;
            const idx = fileList.findIndex(f => f.name === currentFile);
            let prevIdx = idx - 1;
            if (prevIdx < 0) prevIdx = fileList.length - 1; // Wrap
            playFile(fileList[prevIdx].name);
        }

        function toggleLoopMode() {
            loopMode = loopMode === 'list' ? 'single' : 'list';
            const icon = document.getElementById('icon-loop');
            const btn = document.getElementById('btn-loop');
            
            if (loopMode === 'single') {
                icon.textContent = 'repeat_one';
                btn.classList.add('text-primary');
            } else {
                icon.textContent = 'repeat';
                btn.classList.remove('text-primary');
            }
        }

        function handleFileEnded() {
            console.log('Handling file ended, loopMode:', loopMode);
            if (loopMode === 'single') {
                playFile(currentFile);
            } else {
                playNext();
            }
        }

        function updateVolume(val) {
            document.getElementById('volume-label').textContent = val + '%';
            const floatVol = val / 100.0;
            // Debounce could be added here if needed, but basic throttle via WS should be okay for local network
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'set_volume', volume: floatVol }));
            }
        }

        // --- Intercom Logic ---

        function startIntercom() {
             if (isRecording) return;
            isRecording = true;
            
            const btn = document.getElementById('btn-intercom');
            btn.classList.add('bg-red-600', 'hover:bg-red-500');
            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
            
            if (ws.readyState === WebSocket.OPEN) {
                // Stop playback if any
                ws.send(JSON.stringify({ type: 'stop' }));
                isPlaying = false;
                isPaused = false;
                updatePlayButton();
                nameEl.textContent = "对讲中";
                playingIcon.classList.remove('animate-spin-slow');
            }

            if (!recorder) {
                recorder = new Recorder({
                    sampleBits: 16,
                    sampleRate: 48000,
                    numChannels: 1
                });
                
                recorder.onPCM = function(pcmData) {
                    if (ws && ws.readyState === WebSocket.OPEN && isRecording) {
                         ws.send(pcmData.buffer);
                    }
                };
            }
             recorder.start();
        }

        function stopIntercom() {
            if (!isRecording) return;
            isRecording = false;

            const btn = document.getElementById('btn-intercom');
            btn.classList.remove('bg-red-600', 'hover:bg-red-500');
            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            
            if (recorder) {
                recorder.stop();
            }
             nameEl.textContent = "对讲结束";
        }

        // --- File Upload Logic ---

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const CHUNK_SIZE = 1024 * 64; 
            const filename = file.name;
            const fileSize = file.size;

            const status = document.getElementById('upload-status');
            if(status) status.classList.remove('hidden');

            ws.send(JSON.stringify({
                type: 'upload_start',
                filename: filename
            }));

            let offset = 0;
            const reader = new FileReader();

            reader.onload = function(e) {
                const buffer = e.target.result;
                 const base64String = arrayBufferToBase64(buffer);

                const progress = Math.min(100, Math.round((offset / fileSize) * 100));
                if(status) status.textContent = `正在上传 ${progress}%...`;

                ws.send(JSON.stringify({
                    type: 'upload_chunk',
                    filename: filename,
                    data: base64String
                }));

                offset += CHUNK_SIZE;
                if (offset < fileSize) {
                    readNextChunk();
                } else {
                    ws.send(JSON.stringify({
                        type: 'upload_end',
                        filename: filename
                    }));
                    input.value = ''; 
                    setTimeout(() => {
                        if(status) {
                            status.classList.add('hidden');
                            status.textContent = '正在上传...';
                        }
                    }, 2000);
                }
            };

            function readNextChunk() {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            }

            function arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }

            readNextChunk();
        }

        // Initialize
        connect();

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlay();
            }
        });

    </script>
</body>
</html>
